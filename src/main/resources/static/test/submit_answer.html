<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Join Room & Play Quiz</title>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h2, h3 { margin-top: 20px; }
    pre { background: #f4f4f4; padding: 10px; border-radius: 5px; }
    label { display: block; margin-top: 10px; }
    button { margin-top: 10px; padding: 6px 12px; }
  </style>
</head>
<body>
  <h2>ğŸ¯ Join Room & Play Quiz</h2>

  <!-- ThÃ´ng tin Ä‘á»ƒ join -->
  <label>PIN Code: <input type="text" id="pin" placeholder="Nháº­p mÃ£ PIN"></label>
  <label>Token (JWT):<br>
    <textarea id="token" rows="3" cols="80" placeholder="Bearer token..."></textarea>
  </label>
  <label>Room ID: <input type="number" id="roomId" value="6"></label>
  <button onclick="connectAndJoin()">Join Room</button>
  <label>Client Session ID: <input type="text" id="clientSessionId" readonly></label>

  <h3>Káº¿t quáº£ Join:</h3>
  <pre id="joinResult">ChÆ°a join</pre>

  <h3>Danh sÃ¡ch ngÆ°á»i chÆ¡i:</h3>
  <ul id="participant-list"></ul>

  <hr>

  <!-- Form dÃ¹ng Support Card -->
  <h3>ğŸƒ DÃ¹ng Support Card</h3>
  <label>Chá»n tháº»:</label>
  <select id="supportCardType">
    <option value="RETRY_ANSWER">ğŸ”„ Retry Answer</option>
    <option value="HIDE_ANSWER">ğŸ™ˆ Hide Answer</option>
    <option value="DOUBLE_SCORE">âœ¨ Double Score</option>
  </select>
  <button onclick="useSupportCard()">Use Card</button>

  <h3>Káº¿t quáº£ dÃ¹ng tháº»:</h3>
  <pre id="supportCardResult">ChÆ°a dÃ¹ng tháº» nÃ o...</pre>

  <hr>

  <!-- Form submit answer -->
  <h3>ğŸ“¤ Submit Answer</h3>
  <label>Client Session ID: <input type="text" id="sessionId"></label>
  <label>Selected Answer: <input type="text" id="selectedAnswer" value="35"></label>
  <button onclick="submitAnswer()">Submit Answer</button>

  <h3>WebSocket Messages:</h3>
  <pre id="wsMessages">Waiting for WebSocket messages...</pre>

<script>
let stompClient = null;
let clientSessionId = null;
let currentRoomId = null;
let currentPin = null;

async function connectAndJoin() {
  const pin = document.getElementById("pin").value.trim();
  const token = document.getElementById("token").value.trim();
  const resultBox = document.getElementById("joinResult");

  if (!pin || !token) {
    resultBox.textContent = "âŒ Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ PIN vÃ  Token";
    return;
  }

  try {
    // 1ï¸âƒ£ Gá»i API join
    const response = await fetch(`http://localhost:8080/rooms/join?pin=${pin}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      }
    });

    const data = await response.json();
    console.log("Join API response:", data);

    clientSessionId = data.clientSessionId;
    currentRoomId = data.roomId;
    currentPin = pin;

    document.getElementById("clientSessionId").value = clientSessionId;
    document.getElementById("sessionId").value = clientSessionId;
    resultBox.textContent = JSON.stringify(data, null, 2);

    // 2ï¸âƒ£ Káº¿t ná»‘i WebSocket
    const socket = new SockJS('http://localhost:8080/ws');
    stompClient = Stomp.over(socket);

    stompClient.connect({ clientSessionId, pinCode: pin }, () => {
      console.log("âœ… WebSocket káº¿t ná»‘i thÃ nh cÃ´ng");

      // Nháº­n broadcast cá»§a phÃ²ng
      stompClient.subscribe(`/topic/room/${currentRoomId}`, (msg) => {
        console.log("ğŸ“© Room Broadcast:", msg.body);
        appendMessage("Room Broadcast:\n" + msg.body);
      });

      // Nháº­n cÃ¢u há»i riÃªng cho client
      stompClient.subscribe("/user/queue/next-question", (msg) => {
        console.log("ğŸ“© Next Question:", msg.body);
        appendMessage("Next Question:\n" + msg.body);
        try {
          const question = JSON.parse(msg.body);
          renderQuestion(question);
        } catch (e) {
          console.error("KhÃ´ng parse Ä‘Æ°á»£c cÃ¢u há»i:", e);
        }
      });
    });
  } catch (error) {
    resultBox.textContent = `âŒ Lá»—i: ${error.message}`;
    console.error(error);
  }
}

function submitAnswer() {
  const sessionId = document.getElementById("sessionId").value;
  const selectedAnswer = document.getElementById("selectedAnswer").value;
  const token = document.getElementById("token").value.trim();

  if (!token || !sessionId || !currentPin) {
    alert("âš ï¸ Cáº§n join room trÆ°á»›c khi submit!");
    return;
  }

  const answerBody = {
    selectedAnswer,
    clientSessionId: sessionId
  };

  fetch(`http://localhost:8080/room/${currentPin}/submit-answer`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${token}`
    },
    body: JSON.stringify(answerBody)
  })
  .then(response => {
    if (!response.ok) {
      return response.text().then(text => { throw new Error(text) });
    }
    return response.json();
  })
  .then(data => {
    console.log("API Response:", data);
    appendMessage("Submit Answer Response:\n" + JSON.stringify(data, null, 2));
  })
  .catch(err => {
    console.error("API Error:", err.message);
    alert("API Error: " + err.message);
  });
}

function useSupportCard() {
  const token = document.getElementById("token").value.trim();
  const sessionId = document.getElementById("sessionId").value;
  const cardType = document.getElementById("supportCardType").value;

  if (!token || !sessionId || !currentPin) {
    alert("âš ï¸ Cáº§n join room trÆ°á»›c khi dÃ¹ng tháº»!");
    return;
  }

  const body = {
    clientSessionId: sessionId,
    cardType: cardType
  };

  fetch(`http://localhost:8080/${currentPin}/support-card`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${token}`
    },
    body: JSON.stringify(body)
  })
  .then(response => {
    if (!response.ok) {
      return response.text().then(text => { throw new Error(text) });
    }
    return response.json();
  })
  .then(data => {
    console.log("Support Card API Response:", data);
    document.getElementById("supportCardResult").textContent =
      JSON.stringify(data, null, 2);
    appendMessage("DÃ¹ng tháº» " + cardType + " thÃ nh cÃ´ng");
  })
  .catch(err => {
    console.error("Support Card API Error:", err.message);
    alert("API Error: " + err.message);
  });
}

function appendMessage(text) {
  const wsBox = document.getElementById('wsMessages');
  wsBox.textContent += "\n\n" + text;
}

function updateParticipantListUI(participants) {
  const list = document.getElementById("participant-list");
  list.innerHTML = "";
  participants.forEach(p => {
    const li = document.createElement("li");
    li.textContent = p.firstname ? `${p.firstname} (${p.id})` : p;
    list.appendChild(li);
  });
}

function renderQuestion(question) {
  console.log("Render cÃ¢u há»i:", question);
  appendMessage("Render Question:\n" + JSON.stringify(question, null, 2));
}
</script>
</body>
</html>
