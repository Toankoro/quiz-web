<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Join Room & Submit Answer</title>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
  <h2>🎯 Join Room & Submit Answer</h2>

  <!-- Thông tin để join -->
  <label>PIN Code: <input type="text" id="pin" placeholder="Nhập mã PIN"></label><br>
  <label>Token (JWT):<br>
    <textarea id="token" rows="3" cols="80" placeholder="Bearer token..."></textarea>
  </label><br><br>
  <button onclick="connectAndJoin()">Join Room</button>

  <h3>Kết quả Join:</h3>
  <pre id="joinResult"></pre>

  <h3>Danh sách người chơi:</h3>
  <ul id="participant-list"></ul>

  <hr>

  <!-- Form submit answer -->
  <h3>📤 Submit Answer</h3>
  <label>Client Session ID: <input type="text" id="sessionId"></label><br>
  <label>Selected Answer: <input type="text" id="selectedAnswer" value="35"></label><br>
  <label>Time Taken (ms): <input type="number" id="timeTaken" value="5"></label><br>
  <button onclick="submitAnswer()">Submit Answer</button>

  <h3>WebSocket Messages:</h3>
  <pre id="wsMessages">Waiting for WebSocket messages...</pre>

<script>
let stompClient = null;
let clientSessionId = null;
let currentRoomId = null;
let currentPin = null;

function connectAndJoin() {
  const pin = document.getElementById("pin").value.trim();
  const token = document.getElementById("token").value.trim();
  const resultBox = document.getElementById("joinResult");

  if (!pin || !token) {
    resultBox.textContent = "❌ Vui lòng nhập đầy đủ PIN và Token";
    return;
  }

  currentPin = pin;

  const socket = new SockJS('http://localhost:8080/ws');
  stompClient = Stomp.over(socket);

  stompClient.connect({ clientSessionId: sessionId }, () => {
    console.log("✅ WebSocket kết nối thành công");

    // Subscribe cập nhật người chơi
    stompClient.subscribe(`/topic/room/${pin}`, (message) => {
      try {
        const participants = JSON.parse(message.body);
        updateParticipantListUI(participants);
      } catch (e) {
        appendMessage("Room Broadcast:\n" + message.body);
      }
    });

    // Subscribe các kênh khác
    stompClient.subscribe('/user/queue/answer-result', (message) => {
      appendMessage("Answer Result:\n" + message.body);
    });

    stompClient.subscribe('/user/queue/next-question', (message) => {
      appendMessage("Next Question:\n" + message.body);
    });

    console.log("✅ Subscribed các kênh cần thiết");

    // Sau khi WS connect → gọi API join
    joinRoomAPI(pin, token);
  }, (error) => {
    console.error("❌ WebSocket lỗi:", error);
    resultBox.textContent = "❌ Không thể kết nối WebSocket";
  });
}

async function joinRoomAPI(pin, token) {
  const resultBox = document.getElementById("joinResult");

  try {
    const response = await fetch(`http://localhost:8080/rooms/join?pin=${pin}`, {
      method: 'POST',
      headers: {
        "Content-Type": "application/json",
        'Authorization': `Bearer ${token}`
      }
    });

    const rawText = await response.text();

    if (!response.ok) {
      throw new Error(rawText || "Tham gia thất bại");
    }

    const data = JSON.parse(rawText);
    resultBox.textContent = JSON.stringify(data, null, 2);

    clientSessionId = data.clientSessionId;
    currentRoomId = data.roomId; // backend cần trả roomId khi join
    document.getElementById("sessionId").value = clientSessionId;

    appendMessage(`Joined Room ${pin} thành công. Session: ${clientSessionId}`);

  } catch (error) {
    resultBox.textContent = `❌ Lỗi: ${error.message}`;
    console.error(error);
  }
}

function submitAnswer() {
  const sessionId = document.getElementById("sessionId").value;
  const selectedAnswer = document.getElementById("selectedAnswer").value;
  const timeTaken = parseInt(document.getElementById("timeTaken").value);
  const token = document.getElementById("token").value.trim();

  if (!token || !sessionId || !currentPin) {
    alert("⚠️ Cần join room trước khi submit!");
    return;
  }

  const answerBody = {
    selectedAnswer: selectedAnswer,
    timeTaken: timeTaken,
    clientSessionId: sessionId
  };

  fetch(`http://localhost:8080/room/${currentPin}/submit-answer`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${token}`
    },
    body: JSON.stringify(answerBody)
  })
  .then(response => {
    if (!response.ok) {
      return response.text().then(text => { throw new Error(text) });
    }
    return response.json();
  })
  .then(data => {
    console.log("API Response:", data);
    appendMessage("Submit Answer Response:\n" + JSON.stringify(data, null, 2));
  })
  .catch(err => {
    console.error("API Error:", err.message);
    alert("API Error: " + err.message);
  });
}

function appendMessage(text) {
  const wsBox = document.getElementById('wsMessages');
  wsBox.textContent += "\n\n" + text;
}

function updateParticipantListUI(participants) {
  const list = document.getElementById("participant-list");
  list.innerHTML = "";
  participants.forEach(p => {
    const li = document.createElement("li");
    li.textContent = p.firstname ? `${p.firstname} (${p.id})` : p;
    list.appendChild(li);
  });
}
</script>
</body>
</html>
