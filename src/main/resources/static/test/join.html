<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Tham gia ph√≤ng</title>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
  <h2>Tham gia ph√≤ng</h2>

  <label for="pin">Nh·∫≠p m√£ PIN ph√≤ng:</label>
  <input type="text" id="pin" placeholder="Nh·∫≠p m√£ PIN">
  <br><br>

  <label for="token">Nh·∫≠p token (Bearer):</label>
  <input type="text" id="token" placeholder="Bearer token...">
  <br><br>

  <button onclick="connectStompAndSubscribe()">Tham gia</button>

  <h3>K·∫øt qu·∫£:</h3>
  <pre id="result"></pre>

  <h3>Danh s√°ch ng∆∞·ªùi ch∆°i:</h3>
  <ul id="participant-list"></ul>

  <script>
    let stompClient = null;
    let clientSessionId = null;

    function connectStompAndSubscribe() {
      const pin = document.getElementById("pin").value.trim();
      const token = document.getElementById("token").value.trim();
      const resultBox = document.getElementById("result");

      if (!pin || !token) {
        resultBox.textContent = "‚ùå Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß PIN v√† Token";
        return;
      }

      const socket = new SockJS('http://localhost:8080/ws');
      stompClient = Stomp.over(socket);

      stompClient.connect({}, () => {
        console.log("‚úÖ WebSocket k·∫øt n·ªëi th√†nh c√¥ng");

        stompClient.subscribe("/topic/room/" + pin, (message) => {
          const participants = JSON.parse(message.body);
          console.log("üì¢ C·∫≠p nh·∫≠t ng∆∞·ªùi ch∆°i:", participants);
          updateParticipantListUI(participants);
        });
        console.log("‚úÖ ƒê√£ subscribe v√†o ph√≤ng:", pin);

        // G·ªçi API tham gia ph√≤ng sau khi subscribe th√†nh c√¥ng
        joinRoom(pin, token);
      }, (error) => {
        console.error("‚ùå WebSocket l·ªói:", error);
        resultBox.textContent = "‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi WebSocket";
      });
    }

    async function joinRoom(pin, token) {
      const resultBox = document.getElementById("result");

      try {
        const response = await fetch(`http://localhost:8080/rooms/join?pin=${pin}`, {
          method: 'POST',
          headers: {
            "Content-Type": "application/json",
            'Authorization': `Bearer ${token}`
          }
        });

        const rawText = await response.text();

        if (!response.ok) {
          throw new Error(rawText || "Tham gia th·∫•t b·∫°i");
        }

        const data = JSON.parse(rawText);
        console.log("‚úÖ Tham gia th√†nh c√¥ng:", data);

        resultBox.textContent = JSON.stringify(data, null, 2);
        clientSessionId = data.clientSessionId;

      } catch (error) {
        resultBox.textContent = `‚ùå L·ªói: ${error.message}`;
        console.error(error);
      }
    }

    function updateParticipantListUI(participants) {
      const list = document.getElementById("participant-list");
      list.innerHTML = "";

      participants.forEach(p => {
        const li = document.createElement("li");
        li.textContent = p;
        list.appendChild(li);
      });
    }
  </script>
</body>
</html>
