<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Test Start Room & Next Question</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 10px;
      }
      pre {
        background: #f3f3f3;
        padding: 10px;
        border-radius: 5px;
      }
      input,
      textarea {
        margin-bottom: 8px;
        width: 300px;
      }
      button {
        margin-right: 10px;
      }
    </style>
  </head>
  <body>
    <h2>WebSocket & API Test</h2>

    <label>JWT Token:</label><br />
    <textarea id="token" rows="3" placeholder="Paste JWT token here"></textarea
    ><br />

    <label>Room ID:</label><br />
    <input type="number" id="roomId" value="6" /><br />

    <label>Pin Code:</label><br />
    <input type="text" id="pinCode" value="NBDJJ7" /><br />

    <label>Client Session ID:</label><br />
    <input
      type="text"
      id="clientSessionId"
      value="22616c1a-de17-4c15-9857-735702f04539"
    /><br /><br />

    <button onclick="connectWebSocket()">Connect WebSocket</button>
    <button onclick="startRoom()">Start Room</button>
    <button onclick="nextQuestion()">Next Question</button>

    <h3>Messages:</h3>
    <pre id="messageBox">Not connected</pre>

    <script>
      let stompClient = null;

      function logMessage(msg) {
        const box = document.getElementById("messageBox");
        box.textContent += "\n\n" + msg;
      }

      function connectWebSocket() {
        const roomId = document.getElementById("roomId").value;
        const sessionId = document.getElementById("clientSessionId").value;
        const pinCode = document.getElementById("pinCode").value;

        const socket = new SockJS("http://localhost:8080/ws");
        stompClient = Stomp.over(socket);

        stompClient.connect(
          { clientSessionId: sessionId, pinCode: pinCode },
          function () {
            logMessage("‚úÖ Connected WebSocket");

            // Subscribe topic room start
            stompClient.subscribe(`/topic/room/${pinCode}`, function (message) {
              logMessage(`üì¢ Topic /topic/room/${pinCode}:\n${message.body}`);
            });

            // Subscribe personal next-question
            stompClient.subscribe(
              "/user/queue/next-question",
              function (message) {
                logMessage(`‚û°Ô∏è Next Question:\n${message.body}`);
              }
            );

            // Subscribe answer result
            stompClient.subscribe(
              "/user/queue/answer-result",
              function (message) {
                logMessage(`‚úÖ Answer Result:\n${message.body}`);
              }
            );
          },
          function (error) {
            logMessage("‚ùå WebSocket connection error: " + error);
          }
        );
      }

      function startRoom() {
        const roomId = document.getElementById("roomId").value;
        const token = document.getElementById("token").value.trim();

        axios
          .post(
            `http://localhost:8080/rooms/start/${roomId}`,
            {},
            {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          )
          .then((res) => {
            logMessage(
              `üöÄ Start Room Response:\n${JSON.stringify(res.data, null, 2)}`
            );
          })
          .catch((err) => {
            logMessage(`‚ùå Start Room Error:\n${err}`);
          });
      }

      function nextQuestion() {
        const pinCode = document.getElementById("pinCode").value;
        const clientSessionId =
          document.getElementById("clientSessionId").value;
        const token = document.getElementById("token").value.trim();

        axios
          .post(
            `http://localhost:8080/${pinCode}/next-question`,
            {
              clientSessionId: clientSessionId,
            },
            {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          )
          .then((res) => {
            logMessage(
              `‚û°Ô∏è Next Question HTTP Response:\n${JSON.stringify(
                res.data,
                null,
                2
              )}`
            );
          })
          .catch((err) => {
            logMessage(`‚ùå Next Question Error:\n${err}`);
          });
      }
    </script>
  </body>
</html>
