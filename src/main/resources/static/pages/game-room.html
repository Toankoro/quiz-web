<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quiz Game - Phòng chơi</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../styles/game-room.css" />
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
  </head>
  <body>
    <div class="container">
      <!-- Waiting Room Section -->
      <div id="waitingRoom" class="waiting-room">
        <div class="room-info">
          <h2><i class="fas fa-gamepad"></i> Phòng chờ</h2>
          <div class="room-code"></div>
          <div class="player-name"></div>
        </div>

        <div class="players-list">
          <h3><i class="fas fa-users"></i> Người chơi trong phòng</h3>
          <div id="playersList"></div>
        </div>

        <div class="waiting-message">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Đang chờ host bắt đầu trò chơi...</p>
        </div>
      </div>

      <!-- Game Section -->
      <div id="gameSection" class="game-section" style="display: none">
        <div class="question-container">
          <h3><i class="fas fa-question-circle"></i> Câu hỏi</h3>

          <!-- Question Image -->
          <div class="question-image">
            <img
              id="questionImage"
              style="
                display: none;
                max-width: 100%;
                height: auto;
                border-radius: 10px;
              "
            />
          </div>

          <!-- Question Content -->
          <div class="question-content">
            <p id="questionContent"></p>
          </div>

          <!-- Answer Options -->
          <div class="answer-options">
            <button class="answer-btn" id="answerA" onclick="selectAnswer('A')">
              <span class="answer-label">A.</span>
              <span class="answer-text" id="answerA"></span>
            </button>
            <button class="answer-btn" id="answerB" onclick="selectAnswer('B')">
              <span class="answer-label">B.</span>
              <span class="answer-text" id="answerB"></span>
            </button>
            <button class="answer-btn" id="answerC" onclick="selectAnswer('C')">
              <span class="answer-label">C.</span>
              <span class="answer-text" id="answerC"></span>
            </button>
            <button class="answer-btn" id="answerD" onclick="selectAnswer('D')">
              <span class="answer-label">D.</span>
              <span class="answer-text" id="answerD"></span>
            </button>
          </div>

          <!-- Submit Button -->
          <button
            class="btn btn-primary"
            onclick="submitAnswer()"
            style="margin-top: 20px"
          >
            <i class="fas fa-paper-plane"></i> Gửi câu trả lời
          </button>
        </div>

        <!-- Answer Result -->
        <div class="answer-result" id="answerResult" style="display: none">
          <h4><i class="fas fa-chart-bar"></i> Kết quả</h4>
          <p id="resultText"></p>
          <p id="resultScore"></p>
        </div>
        <!-- Support Cards -->
        <div class="support-cards">
          <h4><i class="fas fa-magic"></i> Thẻ hỗ trợ</h4>
          <div class="cards-container">
            <button
              class="support-card"
              onclick="useSupportCard('DOUBLE_SCORE')"
            >
              <i class="fas fa-star"></i>
              <span>Nhân đôi điểm</span>
            </button>
            <button class="support-card" onclick="useSupportCard('HALF_SCORE')">
              <i class="fas fa-cut"></i>
              <span>Giảm một nửa</span>
            </button>
            <button
              class="support-card"
              onclick="useSupportCard('HIDE_ANSWER')"
            >
              <i class="fas fa-eye-slash"></i>
              <span>Ẩn đáp án</span>
            </button>
            <button
              class="support-card"
              onclick="useSupportCard('SKIP_QUESTION')"
            >
              <i class="fas fa-forward"></i>
              <span>Bỏ qua</span>
            </button>
          </div>
        </div>

        <!-- Leaderboard -->
        <div
          class="leaderboard"
          id="leaderboardContainer"
          style="display: none"
        >
          <h4><i class="fas fa-trophy"></i> Bảng xếp hạng</h4>
          <div class="question-info" id="questionInfo"></div>
          <div class="leaderboard-content" id="leaderboardContent">
            <!-- Leaderboard rows will be populated here -->
          </div>
        </div>
      </div>
      <!-- Status Messages -->
      <div id="statusMessages"></div>
      <!-- Nút rời phòng khi game kết thúc -->
      <button id="leaveRoomBtn" style="display: none">Rời phòng</button>
    </div>

    <script>
      // Global variables
      let stompClient = null;
      let currentRoomCode = null;
      let currentPlayerName = null;
      let clientSessionId = null;
      let selectedAnswer = null;
      let questionStartTime = Date.now();
      let gameStarted = false;

      // Add a variable to store current question
      let currentQuestion = null;
      let usedCards = new Set(); // Track used cards for current question

      // Initialize when page loads
      window.addEventListener("load", function () {
        const sessionInfo = localStorage.getItem("quizSessionInfo");
        if (!sessionInfo) {
          window.location.href = "join.html";
          return;
        }

        const info = JSON.parse(sessionInfo);
        currentRoomCode = info.currentRoomCode;
        currentPlayerName = info.currentPlayerName;
        clientSessionId = info.clientSessionId;

        initializeRoom();
      });

      function initializeRoom() {
        // Display room info
        document.querySelector(
          ".room-code"
        ).textContent = `Mã phòng: ${currentRoomCode}`;
        document.querySelector(
          ".player-name"
        ).textContent = `Tên: ${currentPlayerName}`;

        // Connect WebSocket
        connectWebSocket();
      }

      function connectWebSocket() {
        const socket = new SockJS("http://localhost:8080/ws");
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
          console.log("Connected to WebSocket");

          // gửi danh sách người chơi
          stompClient.subscribe(
            `/topic/room/${currentRoomCode}/players`,
            function (response) {
              const players = JSON.parse(response.body);
              updatePlayersList(players);
            }
          );

          // Bắt đầu game khi host gửi lệnh
          stompClient.subscribe(
            `/topic/room/${currentRoomCode}/start`,
            function () {
              console.log("Game start received");
              gameStarted = true;
              switchToGameMode();
            }
          );
            stompClient.subscribe("/topic/room/" + currentRoomCode + "/question", function (response) {
              const question = JSON.parse(response.body);
              if (document.getElementById("gameSection")) {
                document.getElementById("gameSection").style.display = "block";
              }
              if (document.getElementById("leaveRoomBtn")) {
                document.getElementById("leaveRoomBtn").style.display = "none";
              }
              showQuestion(question);
            });

          // Subscribe to other game topics
          subscribeToGameTopics();

          // Send join message
          stompClient.send(
            `/app/room/${currentRoomCode}/join`,
            {},
            JSON.stringify({
              clientSessionId: clientSessionId,
              playerName: currentPlayerName,
            })
          );
        });
      }

      function switchToGameMode() {
        document.getElementById("waitingRoom").style.display = "none";
        document.getElementById("gameSection").style.display = "block";
        addStatus("Game đã bắt đầu!", "success");
      }

      // Update players list in waiting room
      function updatePlayersList(players) {
        const container = document.getElementById("playersList");
        if (!container) return;

        container.innerHTML = "";

        players.forEach((player) => {
          const playerDiv = document.createElement("div");
          playerDiv.className = "player-item";
          playerDiv.innerHTML = `
                <div class="player-info">
                    <span class="player-name">${player.playerName}</span>
                    <span class="player-status ${
                      player.online ? "online" : "offline"
                    }">
                        <i class="fas fa-circle"></i>
                        ${player.online ? "Online" : "Offline"}
                    </span>
                </div>
                ${
                  gameStarted
                    ? `<div class="player-score">${
                        player.score || 0
                      } điểm</div>`
                    : ""
                }
            `;
          container.appendChild(playerDiv);
        });
      }

      // Global functions for status messages, question display, etc.
      // ... (keep your existing global functions here) ...

      // Show question
      function showQuestion(question) {
        // Store current question
        console.log(question); // test console log question in browser
        currentQuestion = question;

        // Switch to game section if not already visible
        document.getElementById("waitingRoom").style.display = "none";
        document.getElementById("gameSection").style.display = "block";

        // Reset timer and question state
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
        questionStartTime = Date.now();
        selectedAnswer = null;

        // Display question content
        document.getElementById("questionContent").textContent =
          question.content;

        // Update answer buttons with actual values and show all buttons
        document.querySelector("#answerA .answer-text").textContent =
          question.answerA;
        document.querySelector("#answerB .answer-text").textContent =
          question.answerB;
        document.querySelector("#answerC .answer-text").textContent =
          question.answerC;
        document.querySelector("#answerD .answer-text").textContent =
          question.answerD;

        // Show all answer buttons (in case they were hidden by previous card)
        document.querySelectorAll(".answer-btn").forEach((btn) => {
          btn.style.display = "block";
          btn.classList.remove("selected");
          btn.disabled = false;
        });

        // Reset timer display with actual question time limit
        const timerDisplay = document.getElementById("timerDisplay");
        if (timerDisplay) {
          timerDisplay.textContent = `${question.limitedTime}s`;
          timerDisplay.className = "timer-normal";
        }

        // Store the time limit for this question
        myTimeLimit = question.limitedTime * 1000; // Convert to milliseconds
        questionStartTime = Date.now();

        // Start the timer immediately
        startTimer(questionStartTime, myTimeLimit);

        // Show/hide image
        const questionImage = document.getElementById("questionImage");
        if (question.imageUrl) {
          questionImage.src = question.imageUrl;
          questionImage.style.display = "block";
        } else {
          questionImage.style.display = "none";
        }

        // Hide previous result
        const answerResult = document.getElementById("answerResult");
        if (answerResult) {
          answerResult.style.display = "none";
        }

        // Reset support cards for new question
        document.querySelectorAll(".support-card").forEach((card) => {
          card.disabled = false;
          card.classList.remove("used");
          card.style.opacity = "1";
          card.style.cursor = "pointer";
        });

        // Reset used cards tracking
        usedCards.clear();
      }

      // Update question with hidden answers (when using hide answer card)
      function updateQuestionWithHiddenAnswers(question) {
        currentQuestion = question;
        if (question.answerA === null) {
          document.querySelector("#answerA").style.display = "none";
        } else {
          document.querySelector("#answerA").style.display = "block";
          document.querySelector("#answerA .answer-text").textContent =
            question.answerA;
        }

        if (question.answerB === null) {
          document.querySelector("#answerB").style.display = "none";
        } else {
          document.querySelector("#answerB").style.display = "block";
          document.querySelector("#answerB .answer-text").textContent =
            question.answerB;
        }

        if (question.answerC === null) {
          document.querySelector("#answerC").style.display = "none";
        } else {
          document.querySelector("#answerC").style.display = "block";
          document.querySelector("#answerC .answer-text").textContent =
            question.answerC;
        }

        if (question.answerD === null) {
          document.querySelector("#answerD").style.display = "none";
        } else {
          document.querySelector("#answerD").style.display = "block";
          document.querySelector("#answerD .answer-text").textContent =
            question.answerD;
        }

        // Show notification that card was applied
        addStatus("Đã áp dụng thẻ ẩn 2 câu trả lời!", "success");
      }

      // Handle answer selection
      function selectAnswer(answer) {
        // Check if the selected answer is available (not hidden)
        let answerValue = null;
        switch (answer) {
          case "A":
            if (currentQuestion.answerA === null) {
              addStatus("Câu trả lời này đã bị ẩn!", "error");
              return;
            }
            answerValue = currentQuestion.answerA;
            break;
          case "B":
            if (currentQuestion.answerB === null) {
              addStatus("Câu trả lời này đã bị ẩn!", "error");
              return;
            }
            answerValue = currentQuestion.answerB;
            break;
          case "C":
            if (currentQuestion.answerC === null) {
              addStatus("Câu trả lời này đã bị ẩn!", "error");
              return;
            }
            answerValue = currentQuestion.answerC;
            break;
          case "D":
            if (currentQuestion.answerD === null) {
              addStatus("Câu trả lời này đã bị ẩn!", "error");
              return;
            }
            answerValue = currentQuestion.answerD;
            break;
        }

        // Remove previous selection
        document.querySelectorAll(".answer-btn").forEach((btn) => {
          btn.classList.remove("selected");
        });

        // Select current answer
        document.getElementById("answer" + answer).classList.add("selected");

        // Store the selected answer
        selectedAnswer = answerValue;
      }

      // Submit answer
      function submitAnswer() {
        if (!selectedAnswer) {
          addStatus("Vui lòng chọn một đáp án!", "error");
          return;
        }

        if (!stompClient || !stompClient.connected) {
          addStatus("Không có kết nối WebSocket!", "error");
          return;
        }

        // Disable all answer buttons
        document.querySelectorAll(".answer-btn").forEach((btn) => {
          btn.disabled = true;
        });

        // Send answer
        stompClient.send(
          "/app/room/" + currentRoomCode + "/submit-answer",
          {},
          JSON.stringify({
            clientSessionId: clientSessionId,
            selectedAnswer: selectedAnswer,
            timeTaken: Date.now() - questionStartTime,
          })
        );

        addStatus("Đã gửi câu trả lời!", "success");
      }

      // Show answer result
      function showAnswerResult(result) {
        console.log("Showing answer result:", result);

        const resultDiv = document.getElementById("answerResult");
        const resultText = document.getElementById("resultText");
        const resultScore = document.getElementById("resultScore");

        if (!resultDiv || !resultText || !resultScore) {
          console.error("Answer result elements not found!");
          return;
        }

        resultDiv.style.display = "block"; // Make sure this is set before updating content

        if (result.correct) {
          resultText.textContent = "Chính xác! 🎉";
          resultText.className = "result-correct";
        } else {
          resultText.textContent = "Sai rồi! 😔";
          resultText.className = "result-incorrect";
        }

        resultScore.textContent = `Điểm: ${result.score}`;

        addStatus(
          `Kết quả: ${result.correct ? "Đúng" : "Sai"} - ${result.score} điểm`,
          result.correct ? "success" : "error"
        );
      }

      // Show game over
      function showGameOver(message) {
        const gameSection = document.getElementById("gameSection");
        gameSection.innerHTML = `
          <div class="game-over">
            <h2><i class="fas fa-trophy"></i> Game Over</h2>
            <p>${message}</p>
          </div>
        `;

        // Clear any existing timers
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }

        addStatus("Game đã kết thúc!", "info");
      }

      // Support card functions
      function useSupportCard(cardType) {
        if (!stompClient || !stompClient.connected) {
          addStatus("Không có kết nối WebSocket!", "error");
          return;
        }

        // Check if card has already been used for current question
        if (usedCards.has(cardType)) {
          addStatus("Thẻ này đã được sử dụng cho câu hỏi hiện tại!", "error");
          return;
        }

        // Disable the card button after using
        const cardButton = event.target.closest(".support-card");
        if (cardButton) {
          cardButton.disabled = true;
          cardButton.classList.add("used");
          cardButton.style.opacity = "0.5";
          cardButton.style.cursor = "not-allowed";
        }

        // Add card to used cards set
        usedCards.add(cardType);

        stompClient.send(
          "/app/room/" + currentRoomCode + "/support-card",
          {},
          JSON.stringify({
            sessionId: clientSessionId,
            cardType: cardType,
          })
        );

        addStatus(`Đã sử dụng thẻ: ${cardType}`, "info");
      }

      // Timer variables
      let timerInterval = null;

      // Start timer
      function startTimer(startTime, timeLimit) {
        const timerDisplay = document.getElementById("timerDisplay");
        if (!timerDisplay) return;

        // Clear any existing timer
        if (timerInterval) {
          clearInterval(timerInterval);
        }

        timerInterval = setInterval(() => {
          const now = Date.now();
          const elapsed = now - startTime;
          const remaining = timeLimit - elapsed;

          if (remaining <= 0) {
            // Time's up!
            clearInterval(timerInterval);
            timerDisplay.textContent = "Hết thời gian!";
            timerDisplay.className = "timer-expired";

            // Disable answer buttons
            document.querySelectorAll(".answer-btn").forEach((btn) => {
              btn.disabled = true;
            });

            // Auto submit if no answer selected
            if (!selectedAnswer) {
              submitAnswer();
            }
          } else {
            // Update display
            const seconds = Math.ceil(remaining / 1000);
            timerDisplay.textContent = `${seconds}s`;
            timerDisplay.className =
              seconds <= 5 ? "timer-warning" : "timer-normal";
          }
        }, 100); // Update more frequently for smoother countdown

        // Show initial time immediately
        const initialSeconds = Math.ceil(timeLimit / 1000);
        timerDisplay.textContent = `${initialSeconds}s`;
        timerDisplay.className = "timer-normal";
      }

      // Update leaderboard
      function updateLeaderboard(leaderboard) {
        const leaderboardContainer = document.getElementById(
          "leaderboardContainer"
        );
        if (!leaderboardContainer) return;

        const leaderboardContent =
          document.getElementById("leaderboardContent");
        leaderboardContent.innerHTML = "";

        leaderboard.players.forEach((player, index) => {
          const playerRow = document.createElement("div");
          playerRow.className = "leaderboard-row";

          const rank = index + 1;
          const rankClass =
            rank === 1
              ? "rank-1"
              : rank === 2
              ? "rank-2"
              : rank === 3
              ? "rank-3"
              : "";

          playerRow.innerHTML = `
            <div class="rank ${rankClass}">${rank}</div>
            <div class="player-name">${player.playerName}</div>
            <div class="player-score">${player.totalScore} điểm</div>
            <div class="player-accuracy">${Math.round(
              player.accuracy * 100
            )}%</div>
          `;

          leaderboardContent.appendChild(playerRow);
        });

        // Hiển thị thông tin câu hỏi
        const questionInfo = document.getElementById("questionInfo");
        if (questionInfo) {
          questionInfo.textContent = `Câu ${leaderboard.currentQuestionIndex}/${leaderboard.totalQuestions}`;
        }

        // Hiển thị leaderboard
        leaderboardContainer.style.display = "block";
      }

      function subscribeToGameTopics() {
        // Subscribe to personal question updates (for hide answer card)
        stompClient.subscribe("/user/queue/question", function (response) {
          const question = JSON.parse(response.body);
          showQuestion(question);
        });
        stompClient.subscribe(
          "/user/queue/question-updated",
          function (response) {
            const question = JSON.parse(response.body);
            updateQuestionWithHiddenAnswers(question);
          }
        );

        // Subscribe to answer results
        stompClient.subscribe("/user/queue/answer-result", function (response) {
          const result = JSON.parse(response.body);
          showAnswerResult(result);
        });

        // Subscribe to leaderboard updates
        stompClient.subscribe(
          `/topic/room/${currentRoomCode}/leaderboard`,
          function (response) {
            const leaderboard = JSON.parse(response.body);
            updateLeaderboard(leaderboard);
          }
        );

        stompClient.subscribe(
          "/topic/room/" + currentRoomCode + "/game-over",
          function (response) {
            // Ẩn khu vực câu hỏi nếu có
            if (document.getElementById("gameSection")) {
              document.getElementById("gameSection").style.display = "none";
            }
            // Ẩn các nút trả lời, hỗ trợ, submit nếu có
            document
              .querySelectorAll(".support-card, .answer-btn, #submitBtn")
              .forEach((btn) => (btn.style.display = "none"));
            // Hiện nút rời phòng
            document.getElementById("leaveRoomBtn").style.display = "block";
            // Hiện bảng điểm cuối cùng
            fetch(`/api/room/${currentRoomCode}/leaderboard`)
              .then((res) => res.json())
              .then((leaderboard) => {
                updateLeaderboard(leaderboard);
                document.getElementById("leaderboardContainer").style.display =
                  "block";
              });
            addStatus("Game đã kết thúc! Bạn có thể rời phòng.", "info");
          }
        );
        // Xử lý nút rời phòng
        if (document.getElementById("leaveRoomBtn")) {
          document.getElementById("leaveRoomBtn").onclick = function () {
            localStorage.removeItem("quizSessionInfo");
            window.location.href = "join.html";
          };
        }
      }

      function addStatus(message, type) {
        const statusDiv = document.createElement("div");
        statusDiv.className = "status " + type;

        const icon =
          type === "success"
            ? "check-circle"
            : type === "error"
            ? "exclamation-circle"
            : "info-circle";

        statusDiv.innerHTML = `<i class="fas fa-${icon}"></i> ${message}`;

        const container = document.getElementById("statusMessages");
        container.appendChild(statusDiv);

        // Auto remove after 5 seconds
        setTimeout(() => statusDiv.remove(), 5000);
      }

      // Initialize
      console.log("Join Room Page initialized");
      addStatus(
        "Chào mừng! Vui lòng nhập thông tin để tham gia phòng.",
        "info"
      );
    </script>
  </body>
</html>
